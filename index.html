<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Error 1101</title>
<style>
  /* 基础样式 */
  html, body { height:100%; margin:0; padding:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:#f4f4f4; }
  
  /* 1101 伪装页面容器 */
  #fakeContainer { height:100vh; max-width:800px; margin:0 auto; padding:30px 20px; text-align:center; background:#ffffff; box-sizing:border-box; position:relative; z-index:10; }
  #fakeContainer h1 { font-size:48px; margin:0; color:#ff4d4d; font-weight:bold; }
  #fakeContainer h2 { font-size:24px; margin:16px 0; color:#444; }
  #fakeContainer p { font-size:16px; margin:8px 0; color:#666; }
  .section { margin:20px 0; text-align:left; border-top:1px solid #eee; padding-top:20px; }
  .feedback-btn { color:#0066ff; text-decoration:underline; cursor:pointer; font-size:14px; margin-top:20px; display:inline-block; }

  /* 真实内容容器 - 初始隐藏 */
  #realContent { 
    display:none; position:fixed; inset:0; z-index:20; 
    background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); 
    color:#fff; flex-direction:column; align-items:center; justify-content:center; text-align:center;
  }
  .main-title { font-size:2.2rem; font-weight:700; background:linear-gradient(90deg,#00f0ff,#a855f7); -webkit-background-clip:text; color:transparent; margin-bottom:20px; }
  .copy-btn { margin:10px 0; padding:12px 30px; background:linear-gradient(90deg,#00f0ff,#a855f7); border:none; border-radius:50px; font-size:16px; cursor:pointer; color:#000; font-weight:bold; width:220px; }
  .notice { margin-top:20px; opacity:0.8; font-size:0.9rem; }

  /* 齿轮按钮 - 初始隐藏，只在 realContent 显示时才出现 */
  #adminGear { 
    display:none; position:fixed; top:20px; right:20px; z-index:100; 
    font-size:30px; cursor:pointer; opacity:0.5; color:#fff;
  }

  /* 弹窗通用样式 */
  .modal { 
    display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); 
    align-items:center; justify-content:center; z-index:1000; 
  }
  .modal-content { 
    background:#fff; padding:25px; border-radius:12px; width:85%; max-width:300px; 
    text-align:center; position:relative; color:#333; 
  }
  /* 叉子按钮样式 */
  .close-btn { 
    position:absolute; top:10px; right:15px; font-size:28px; 
    color:#999; cursor:pointer; line-height:1; 
  }
  .close-btn:hover { color:#333; }

  /* 表单控件 */
  input { width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; }
  button.submit-btn { width:100%; padding:12px; background:#0066ff; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:16px; }
  
  .settings-list { list-style:none; padding:0; margin:15px 0; }
  .settings-list li { padding:12px; background:#f8f9fa; margin:8px 0; border-radius:6px; cursor:pointer; font-size:14px; border:1px solid #eee; }
  .settings-list li:hover { background:#e9ecef; }
</style>
</head>
<body>

<div id="fakeContainer">
  <h1>Error 1101</h1>
  <h2>Worker threw exception</h2>
  <p>Ray ID: <span id="ray-id"></span> • <span id="current-time"></span></p>
  <div class="section">
    <p><strong>What happened?</strong></p>
    <p>You've requested a page on a website that is on the Cloudflare network. An unknown error occurred while rendering the page.</p>
    <div class="feedback-btn" onclick="openModal('userLoginModal')">错误反馈 / Report Issue</div>
  </div>
  <div style="position:absolute; bottom:20px; width:100%; left:0; font-size:12px; color:#999;">Performance & security by Cloudflare</div>
</div>

<div id="adminGear" onclick="openModal('adminMenuModal')">⚙️</div>

<div id="realContent">
  <div id="mainTitle" class="main-title">XUE CF代理</div>
  <button class="copy-btn" onclick="copyLink(1)">复制订阅链接 1</button>
  <button class="copy-btn" onclick="copyLink(2)">复制订阅链接 2</button>
  <p id="tip" style="height:20px; color:#00f0ff; font-size:14px;"></p>
  <p id="notice" class="notice">马到成功吧</p>
</div>

<div id="userLoginModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('userLoginModal')">×</span>
    <h3>提交反馈</h3>
    <p style="font-size:12px; color:#999;">请输入反馈代码以继续</p>
    <input id="userPwdInput" type="password" placeholder="请输入密码">
    <button class="submit-btn" onclick="checkUserPassword()">提交</button>
  </div>
</div>

<div id="adminMenuModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('adminMenuModal')">×</span>
    <h3>管理员设置</h3>
    <ul class="settings-list">
      <li onclick="openEdit('titleText')">修改标题文字</li>
      <li onclick="openEdit('sub1')">修改订阅链接 1</li>
      <li onclick="openEdit('sub2')">修改订阅链接 2</li>
      <li onclick="openEdit('notice')">修改底部说明</li>
      <li onclick="openEdit('bgUrl')">修改背景图URL</li>
      <li onclick="openEdit('userPassword')">修改访问密码</li>
    </ul>
  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('editModal')">×</span>
    <h3 id="editTitle">修改内容</h3>
    <input id="editInput" type="text" placeholder="请输入新值">
    <input id="adminPwConfirm" type="password" placeholder="管理员密码确认">
    <button class="submit-btn" onclick="saveData()">保存并刷新</button>
  </div>
</div>

<script>
let SETTINGS = {
  titleText: "XUE CF代理",
  sub1: "", sub2: "", notice: "马到成功吧",
  bgUrl: "", userPassword: "888"
};

// 初始化 RayID 和 时间
document.getElementById('ray-id').innerText = Math.random().toString(16).slice(2, 14);
document.getElementById('current-time').innerText = new Date().toISOString().replace('T',' ').slice(0,19);

// 获取数据
fetch("/api/get-links?" + Date.now())
  .then(r => r.json())
  .then(data => {
    SETTINGS = { ...SETTINGS, ...data };
    document.getElementById('mainTitle').textContent = SETTINGS.titleText;
    document.getElementById('notice').textContent = SETTINGS.notice;
    if (SETTINGS.bgUrl) {
      document.getElementById('realContent').style.backgroundImage = `url(${SETTINGS.bgUrl})`;
      document.getElementById('realContent').style.backgroundSize = 'cover';
    }
  }).catch(() => {});

// 弹窗通用开关
function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

// 用户密码验证
function checkUserPassword() {
  const pw = document.getElementById('userPwdInput').value;
  if (pw === SETTINGS.userPassword) {
    closeModal('userLoginModal');
    document.getElementById('fakeContainer').style.display = 'none';
    document.getElementById('realContent').style.display = 'flex';
    document.getElementById('adminGear').style.display = 'block'; // 进入后才显示齿轮
  } else {
    alert("反馈已收到，我们会尽快处理！");
    closeModal('userLoginModal');
  }
}

// 复制链接
function copyLink(type) {
  const link = type === 1 ? SETTINGS.sub1 : SETTINGS.sub2;
  if (!link) return alert("未配置链接");
  navigator.clipboard.writeText(link);
  const tip = document.getElementById('tip');
  tip.textContent = "复制成功！";
  setTimeout(() => tip.textContent = "", 2000);
}

// 管理员编辑逻辑
let activeField = "";
function openEdit(field) {
  activeField = field;
  closeModal('adminMenuModal');
  document.getElementById('editInput').value = SETTINGS[field];
  document.getElementById('editTitle').textContent = "修改 " + field;
  openModal('editModal');
}

async function saveData() {
  const val = document.getElementById('editInput').value;
  const pw = document.getElementById('adminPwConfirm').value;
  if(!pw) return alert("请输入管理密码");

  const body = { password: pw };
  body[activeField] = val;

  const res = await fetch("/api/update-links", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();
  if (data.success) {
    alert("更新成功！");
    location.reload();
  } else {
    alert("密码错误或保存失败");
  }
}
</script>
</body>
</html>
