<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Error 1101</title>
<style>
  html, body { height:100%; margin:0; padding:0; overflow:hidden; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:#f4f4f4; }
  .container { height:100vh; max-width:800px; margin:0 auto; padding:20px 20px 40px; text-align:center; background:#ffffff; color:#000; box-sizing:border-box; overflow:hidden; position:relative; z-index:1; }
  h1 { font-size:48px; margin:0; color:#ff4d4d; font-weight:bold; background:#ffffff; }
  h2 { font-size:24px; margin:16px 0; color:#444; background:#ffffff; }
  p { font-size:16px; margin:8px 0; opacity:0.9; background:#ffffff; }
  .section { margin:20px 0; background:#ffffff; }
  .link { color:#0066ff; text-decoration:underline; cursor:pointer; background:#ffffff; }
  .footer { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); font-size:12px; color:#666; text-align:center; width:90%; line-height:1.4; background:#ffffff; z-index:5; }
  .feedback-btn { position:fixed; bottom:20px; right:20px; color:#0066ff; cursor:pointer; font-size:13px; z-index:10; text-decoration:underline; opacity:0.8; transition:all 0.3s; background:#ffffff; }
  .feedback-btn:hover { opacity:1; color:#0044cc; }
  #modal, #adminModal, .edit-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1000; }
  .modal-content { background:#fff; padding:16px; border-radius:12px; width:90%; max-width:280px; text-align:center; position:relative; box-shadow:0 8px 30px rgba(0,0,0,0.3); color:#333; z-index:1001; }
  .close-btn { position:fixed !important; top:8px !important; right:16px !important; background:none !important; border:none !important; color:#aaa !important; font-size:40px !important; line-height:1 !important; cursor:pointer !important; z-index:10001 !important; pointer-events:auto !important; }
  .close-btn:hover { color:#fff !important; }
  input { width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:6px; font-size:15px; box-sizing:border-box; }
  button { width:100%; padding:10px; background:#0066ff; color:#fff; border:none; border-radius:6px; font-size:15px; cursor:pointer; margin-top:8px; }
  #realContent { display:none; position:fixed; inset:0; background:linear-gradient(135deg, #0f0c29, #302b63, #24243e); color:#e0f7ff; flex-direction:column; align-items:center; justify-content:center; padding:10px 20px 30px; text-align:center; background-size:cover; background-position:center; background-attachment:fixed; overflow:hidden; z-index:2; }
  .admin-btn { position:fixed !important; top:8px !important; right:60px !important; background:none !important; border:none !important; color:#aaa !important; font-size:36px !important; cursor:pointer !important; z-index:10000 !important; opacity:0.9; pointer-events:auto !important; }
  .admin-btn:hover { color:#00d1ff !important; }
  .header { margin: 0.5rem 0 1rem 0; display:flex; align-items:center; justify-content:center; flex-wrap:wrap; } /* 上移标题和按钮整体 */
  .main-title { font-size:2.2rem; font-weight:700; letter-spacing:1px; background:linear-gradient(90deg,#00f0ff,#a855f7); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 0 8px rgba(168,85,247,0.5); margin:0.2rem 0; }
  .copy-btn { margin:6px 0; padding:10px 20px; background:linear-gradient(90deg,#00f0ff,#a855f7); border:none; border-radius:50px; font-size:16px; cursor:pointer; color:#000; box-shadow:0 4px 12px rgba(0,240,255,0.3); transition:all 0.3s; white-space:nowrap; display:inline-block; min-width:auto !important; width:auto !important; }
  .copy-btn:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,240,255,0.5); }
  .tip { color:#a5f3fc; opacity:0; transition:opacity 0.4s; margin-top:0.5rem; font-size:0.9rem; }
  .notice { margin-top:1.5rem; opacity:1; font-size:1.1rem; font-weight:500; max-width:80%; word-break:break-all; text-align:center; color:#ffffff; text-shadow:none !important; letter-spacing:1px; background:transparent !important; padding:0 !important; box-shadow:none !important; }
  .settings-list { list-style:none; padding:0; margin:15px 0; }
  .settings-list li { padding:10px; background:#222; margin:5px 0; border-radius:6px; cursor:pointer; text-align:left; color:#fff; font-size:14px; }
  .settings-list li:hover { background:#333; }
</style>
</head>
<body>

<div class="container">
  <h1>Error 1101</h1>
  <h2>Worker threw exception</h2>
  <p>Ray ID: 126a014fe66b3b9b • 2026-01-17 20:36:xx</p>
  <div class="section">
    <h3>What happened?</h3>
    <p>You've requested a page on a website that is on the Cloudflare network. An unknown error occurred while rendering the page.</p>
  </div>
  <div class="section">
    <h3>What can I do?</h3>
    <p>If you are the owner of this website: refer to <a href="https://developers.cloudflare.com/workers/observability/errors/" class="link">Workers - Errors and Exceptions</a> and check Workers Logs.</p>
  </div>
  <div class="footer">Performance & security by Cloudflare</div>
</div>

<div class="feedback-btn" onclick="document.getElementById('modal').style.display='flex'">错误反馈</div>

<!-- 普通反馈弹窗 -->
<div id="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="document.getElementById('modal').style.display='none'">&times;</button>
    <h3>请提交您的反馈意见</h3>
    <input id="pw" type="password" placeholder="描述您遇到的问题">
    <button onclick="checkPassword()">提交</button>
  </div>
</div>

<!-- 管理员主面板 -->
<div id="adminModal">
  <div class="modal-content">
    <button class="close-btn" onclick="document.getElementById('adminModal').style.display='none'">&times;</button>
    <h3>管理员设置</h3>
    <ul class="settings-list">
      <li onclick="editField('titleText')">修改标题文字</li>
      <li onclick="editField('sub1')">修改订阅链接 1</li>
      <li onclick="editField('sub2')">修改订阅链接 2</li>
      <li onclick="editField('notice')">修改底部说明</li>
      <li onclick="editField('bgUrl')">修改背景图URL</li>
      <li onclick="editField('userPassword')">修改访问密码</li>
    </ul>
  </div>
</div>

<!-- 编辑弹窗 -->
<div id="editModal" class="edit-modal">
  <div class="modal-content">
    <button class="close-btn" onclick="document.getElementById('editModal').style.display='none'">&times;</button>
    <h3 id="editTitle">修改</h3>
    <input id="editInput" type="text" placeholder="请输入新值">
    <input id="adminPwForEdit" type="password" placeholder="管理员密码确认">
    <button onclick="saveSingleField()">保存</button>
  </div>
</div>

<!-- 真实内容 -->
<div id="realContent">
  <div class="header">
    <span id="mainTitle" class="main-title">XUE CF代理</span>
  </div>
  <button class="copy-btn" onclick="copyLink(1)">复制订阅链接 1</button>
  <button class="copy-btn" onclick="copyLink(2)">复制订阅链接 2</button>
  <p id="tip" class="tip"></p>
  <p id="notice" class="notice">马到成功吧</p>
  <button class="admin-btn" onclick="document.getElementById('adminModal').style.display='flex'">⚙️</button>
</div>

<script>
let SETTINGS = {
  titleText: "XUE CF代理",
  sub1: "123",
  sub2: "456",
  notice: "马到成功吧",
  bgUrl: "",
  userPassword: "88888888"
};

fetch("/api/get-links?" + new Date().getTime())
  .then(r => r.json())
  .then(data => {
    SETTINGS = { ...SETTINGS, ...data };
    document.getElementById('mainTitle').textContent = SETTINGS.titleText || "XUE CF代理";
    document.getElementById('notice').textContent = SETTINGS.notice;

    if (SETTINGS.bgUrl) {
      document.getElementById('realContent').style.backgroundImage = `url(${SETTINGS.bgUrl})`;
    } else {
      document.getElementById('realContent').style.background = "linear-gradient(135deg, #0f0c29, #302b63, #24243e)";
    }
  })
  .catch(() => {});

// 最终强制定位（只执行一次，避免重复 append）
function forcePosition() {
  // 齿轮
  let adminBtn = document.querySelector('.admin-btn');
  if (adminBtn && adminBtn.parentNode !== document.body) {
    document.body.appendChild(adminBtn);
  }
  if (adminBtn) {
    adminBtn.style.position = 'fixed';
    adminBtn.style.top = '8px';
    adminBtn.style.right = '60px';
    adminBtn.style.zIndex = '10000';
    adminBtn.style.pointerEvents = 'auto';
  }

  // 所有叉子
  document.querySelectorAll('.close-btn').forEach(btn => {
    if (btn.parentNode !== document.body) {
      document.body.appendChild(btn);
    }
    btn.style.position = 'fixed';
    btn.style.top = '8px';
    btn.style.right = '16px';
    btn.style.zIndex = '10001';
    btn.style.pointerEvents = 'auto';
  });
}

// 只执行一次定位（load + 延迟 + 事件触发时）
window.addEventListener('load', forcePosition);
setTimeout(forcePosition, 1000);
setTimeout(forcePosition, 3000); // 保险

function checkPassword() {
  const input = document.getElementById('pw').value.trim();
  if (input === SETTINGS.userPassword) {
    document.getElementById('modal').style.display = 'none';
    document.querySelector('.container').style.display = 'none';
    document.querySelector('.feedback-btn').style.display = 'none';
    document.getElementById('realContent').style.display = 'flex';
    forcePosition(); // 解锁后立即定位
  } else {
    alert("您的意见已经发送，请等待系统处理！");
    document.getElementById('modal').style.display = 'none';
  }
}

function copyLink(type) {
  const link = type === 1 ? SETTINGS.sub1 : SETTINGS.sub2;
  if (!link.trim()) return alert("链接未配置");
  navigator.clipboard.writeText(link);
  document.getElementById('tip').textContent = "已复制到剪贴板";
  document.getElementById('tip').style.opacity = 1;
  setTimeout(() => document.getElementById('tip').style.opacity = 0, 2000);
}

function editField(field) {
  document.getElementById('adminModal').style.display = 'none';
  document.getElementById('editModal').style.display = 'flex';
  const titles = {
    titleText: '修改标题文字',
    sub1: '修改订阅链接 1',
    sub2: '修改订阅链接 2',
    notice: '修改底部说明',
    bgUrl: '修改背景图URL',
    userPassword: '修改访问密码'
  };
  document.getElementById('editTitle').textContent = titles[field];
  document.getElementById('editInput').value = SETTINGS[field];
  document.getElementById('editInput').dataset.field = field;
  forcePosition(); // 打开弹窗后定位
}

async function saveSingleField() {
  const field = document.getElementById('editInput').dataset.field;
  const value = document.getElementById('editInput').value.trim();
  const pw = document.getElementById('adminPwForEdit').value.trim();

  if (!pw) return alert("请输入管理员密码");

  const body = { password: pw };
  body[field] = value;

  const res = await fetch("/api/update-links", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();
  if (data.success) {
    alert("设置已更新！页面刷新中...");
    document.getElementById('editModal').style.display = 'none';
    location.reload(true);
  } else {
    alert("管理员密码错误或更新失败");
  }
}
</script>
</body>
</html>