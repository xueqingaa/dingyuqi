<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Error 1101</title>
<style>
  /* åŸºç¡€ä¸ä¼ªè£…é¡µæ ·å¼ä¿æŒ Cloudflare é£æ ¼ */
  body, html { margin:0; padding:0; font-family: "Segoe UI", Roboto, sans-serif; background:#fff; color:#000; height: 100%; overflow: hidden; }
  #fakePage { padding: 40px 20px; max-width: 800px; margin: 0 auto; }
  .error-title { font-size: 48px; font-weight: 400; color: #404040; margin: 0; }
  .ray-id-row { font-size: 14px; color: #999; margin: 15px 0 30px; font-family: monospace; }
  .cf-link { color: #0051c3; text-decoration: none; cursor: pointer; }

  /* çœŸå®é¢æ¿ */
  #realContent { 
    display:none; position:fixed; inset:0; z-index:100;
    background-size: cover; background-position: center; background-repeat: no-repeat;
    color:#fff; flex-direction:column; align-items:center; 
    padding-top: 15vh; text-align: center;
  }
  #realContent::before { content: ""; position: absolute; inset: 0; background: rgba(0, 0, 0, 0.45); z-index: -1; }
  #canvas { position: fixed; inset: 0; z-index: 50; pointer-events: none; display: none; }

  .main-title { 
    font-size:2.4rem; font-weight:800; background: linear-gradient(90deg,#00f0ff,#a855f7); 
    -webkit-background-clip:text; color:transparent; margin-bottom: 50px;
    text-shadow: 0 4px 12px rgba(0,0,0,0.5);
  }
  .btn-group { display: flex; flex-direction: column; gap: 20px; width: 85%; max-width: 280px; z-index: 101; }
  .copy-btn { 
    padding:16px; background:linear-gradient(90deg,#00f0ff,#a855f7); 
    border:none; border-radius:15px; font-size:17px; cursor:pointer; 
    color:#000; font-weight:bold; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  }

  /* é¡¶éƒ¨æ§åˆ¶ */
  .top-controls { display:none; position:fixed; top:20px; right:20px; z-index:200; display: flex; gap: 20px; align-items: center; }
  .icon-btn { font-size:26px; cursor:pointer; opacity:0.6; color:#fff; transition: 0.3s; }
  @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .music-playing { animation: rotate 3s linear infinite; opacity: 1; text-shadow: 0 0 10px #00f0ff; }

  /* å¼¹çª—æ ·å¼ */
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items:center; justify-content:center; z-index:1000; }
  .modal-content { background:#fff; padding:30px 20px; border-radius:20px; width:88%; max-width:320px; text-align:center; position:relative; color:#333; }
  .close-x { position:absolute; top:12px; right:18px; font-size:30px; color:#ccc; cursor:pointer; line-height:1; }
  input { width:100%; padding:14px; margin:12px 0; border:1px solid #eee; border-radius:10px; box-sizing:border-box; font-size:16px; }
  .primary-btn { width:100%; padding:14px; background:#0051c3; color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight: bold; }
  .settings-list { list-style:none; padding:0; margin:20px 0; }
  .settings-list li { padding:14px; background:#f8f9fa; margin-bottom:10px; border-radius:12px; cursor:pointer; display:flex; justify-content:space-between; border: 1px solid #eee; }
</style>
</head>
<body>

<audio id="bgMusic" preload="auto"></audio>
<canvas id="canvas"></canvas>

<div id="fakePage">
  <h1 class="error-title">Error 1101</h1>
  <p class="ray-id-row">Ray ID: <span id="ray-id"></span> &bull; <span id="ts-id"></span></p>
  <h2 class="status-text">Worker threw exception</h2>
  <h3 style="font-size: 28px; color: #404040; margin: 40px 0 15px;">What happened?</h3>
  <p style="font-size: 16px; color: #404040;">You've requested a page on a website (<span class="domain-info"></span>) that is on the Cloudflare network.</p>
  <p style="font-size: 16px; color: #404040;">refer to <span class="cf-link" onclick="openModal('userLoginModal')">Workers - Errors and Exceptions</span> and check Workers Logs.</p>
  <hr style="border:0; border-top:1px solid #d9d9d9; margin: 40px 0 20px;">
  <div style="font-size: 13px; color: #666;">Cloudflare Ray ID: <strong id="ray-id-ft"></strong><br>Performance & security by Cloudflare</div>
</div>

<div id="topControls" class="top-controls">
  <div id="musicBtn" class="icon-btn" onclick="toggleMusic()">ğŸµ</div>
  <div id="adminGear" class="icon-btn" onclick="handleGearClick()">âš™ï¸</div>
</div>

<div id="realContent">
  <div id="mainTitle" class="main-title">XUEçš„è®¢é˜…åˆ†äº«</div>
  <div class="btn-group">
    <button class="copy-btn" onclick="copyLink(1)">å¤åˆ¶è®¢é˜…é“¾æ¥ 1</button>
    <button class="copy-btn" onclick="copyLink(2)">å¤åˆ¶è®¢é˜…é“¾æ¥ 2</button>
  </div>
  <p id="notice" style="margin-top:40px; color:#a5f3fc; font-size:14px; letter-spacing:1px;"></p>
</div>

<div id="userLoginModal" class="modal">
  <div class="modal-content">
    <span class="close-x" onclick="closeModal('userLoginModal')">&times;</span>
    <h3>Verify Debug Code</h3>
    <input id="userPwdInput" type="password" placeholder="Debug Authorization Code">
    <button class="primary-btn" onclick="doUserLogin()">Verify</button>
  </div>
</div>

<div id="adminVerifyModal" class="modal">
  <div class="modal-content">
    <span class="close-x" onclick="closeModal('adminVerifyModal')">&times;</span>
    <h3>Admin Auth</h3>
    <input id="adminPwdLogin" type="password" placeholder="Admin Password">
    <button class="primary-btn" onclick="verifyAdmin()">Unlock</button>
  </div>
</div>

<div id="adminMenuModal" class="modal">
  <div class="modal-content">
    <span class="close-x" onclick="closeModal('adminMenuModal')">&times;</span>
    <h3>Settings</h3>
    <ul class="settings-list">
      <li onclick="prepEdit('titleText', 'æ ‡é¢˜æ–‡å­—')">æ ‡é¢˜æ–‡å­— â”</li>
      <li onclick="prepEdit('sub1', 'é“¾æ¥ 1')">è®¢é˜…é“¾æ¥ 1 â”</li>
      <li onclick="prepEdit('sub2', 'é“¾æ¥ 2')">è®¢é˜…é“¾æ¥ 2 â”</li>
      <li onclick="prepEdit('bgUrl', 'èƒŒæ™¯å›¾URL')">èƒŒæ™¯å›¾URL â”</li>
      <li onclick="prepEdit('musicUrl', 'éŸ³ä¹æ›²åº“(é€—å·éš”å¼€)')">å¤šæ›²åº“è®¾ç½® â”</li>
      <li onclick="prepEdit('userPassword', 'è®¿é—®å¯†ç ')">è®¿é—®å¯†ç  â”</li>
    </ul>
  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close-x" onclick="closeModal('editModal')">&times;</span>
    <h3 id="editLabel">Modify</h3>
    <input id="editInput" type="text">
    <button class="primary-btn" onclick="submitEdit()">Save</button>
  </div>
</div>

<script>
let SETTINGS = {};
let adminSessionPw = "";
let editingKey = "";
let playlist = [];
let currentTrackIndex = 0;
const audio = document.getElementById('bgMusic');

// é»˜è®¤é…ç½®ï¼ˆåœ¨APIæœªè®¾ç½®å‰ç”Ÿæ•ˆï¼‰
const DEFAULT_MUSIC = "https://music.163.com/song/media/outer/url?id=186001.mp3"; // è’²å…¬è‹±çš„çº¦å®š

// 1. åˆå§‹åŒ–ä¼ªè£…ä¿¡æ¯
const ray = Math.random().toString(16).slice(2, 14);
document.getElementById('ray-id').innerText = ray;
document.getElementById('ray-id-ft').innerText = ray;
document.getElementById('ts-id').innerText = new Date().toISOString().replace('T',' ').slice(0,19) + ' UTC';
document.querySelectorAll('.domain-info').forEach(e => e.innerText = window.location.hostname);

// 2. åŠ è½½é…ç½®
async function load() {
  try {
    const r = await fetch("/api/get-links?" + Date.now());
    SETTINGS = await r.json();
    document.getElementById('mainTitle').innerText = SETTINGS.titleText || "XUEçš„è®¢é˜…åˆ†äº«";
    document.getElementById('notice').innerText = SETTINGS.notice || "";
    if(SETTINGS.bgUrl) document.getElementById('realContent').style.backgroundImage = `url(${SETTINGS.bgUrl})`;
    
    // è§£ææ­Œå•ï¼Œå¦‚æœæ²¡æœ‰å˜é‡åˆ™ä½¿ç”¨é»˜è®¤çš„ã€Šè’²å…¬è‹±çš„çº¦å®šã€‹
    const musicSource = SETTINGS.musicUrl || DEFAULT_MUSIC;
    playlist = musicSource.split(/[,ï¼Œ;ï¼›\s]+/).filter(url => url.trim() !== "");
    currentTrackIndex = Math.floor(Math.random() * playlist.length);
    audio.src = playlist[currentTrackIndex];
  } catch(e) {}
}
load();

// 3. æ ¸å¿ƒæ’­æ”¾å‡½æ•° (åŒ…å«é«˜æ½®è·³è½¬é€»è¾‘)
function playMusic() {
  // å¦‚æœå½“å‰æ’­æ”¾çš„æ˜¯é»˜è®¤çš„ã€Šè’²å…¬è‹±çš„çº¦å®šã€‹ï¼Œä¸”æ˜¯ç¬¬ä¸€æ¬¡æ’­æ”¾
  if(audio.src.includes("id=186001.mp3") && audio.currentTime === 0) {
      audio.currentTime = 61; // å¼ºåˆ¶è·³è½¬åˆ°å‰¯æ­Œ
  }
  audio.play().then(() => {
    document.getElementById('musicBtn').classList.add('music-playing');
  }).catch(() => {});
}

function doUserLogin() {
  if(document.getElementById('userPwdInput').value === SETTINGS.userPassword) {
    document.getElementById('fakePage').style.display = 'none';
    document.getElementById('realContent').style.display = 'flex';
    document.getElementById('topControls').style.display = 'flex';
    document.getElementById('canvas').style.display = 'block';
    closeModal('userLoginModal');
    initParticles(); 
    playMusic();
  } else { alert("Invalid authorization code."); }
}

function toggleMusic() {
  if (audio.paused) {
    playMusic();
  } else {
    currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
    audio.src = playlist[currentTrackIndex];
    // åˆ‡æ¢åå†æ¬¡æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è½¬é«˜æ½®
    audio.oncanplay = function() {
        if(audio.src.includes("id=186001.mp3")) audio.currentTime = 61;
        playMusic();
        audio.oncanplay = null;
    };
  }
}

// è‡ªåŠ¨åˆ‡æ­Œ
audio.onended = () => {
  currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
  audio.src = playlist[currentTrackIndex];
  playMusic();
};

// ç²’å­æ•ˆæœå¼•æ“
function initParticles() {
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const p = [];
  for(let i=0; i<70; i++) p.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*2+1, s:Math.random()*1+0.5});
  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "rgba(255,255,255,0.5)";
    ctx.beginPath();
    p.forEach(m => { ctx.moveTo(m.x, m.y); ctx.arc(m.x, m.y, m.r, 0, Math.PI*2); });
    ctx.fill();
    p.forEach(m => { m.y += m.s; if(m.y > canvas.height) m.y = -10; });
    requestAnimationFrame(draw);
  }
  draw();
}

// åŸºç¡€å¼¹çª—é€»è¾‘ (é½¿è½®ã€ç¼–è¾‘ç­‰)
function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function handleGearClick() { if (adminSessionPw) openModal('adminMenuModal'); else openModal('adminVerifyModal'); }
function verifyAdmin() { adminSessionPw = document.getElementById('adminPwdLogin').value; closeModal('adminVerifyModal'); openModal('adminMenuModal'); }
function prepEdit(key, label) { editingKey = key; document.getElementById('editLabel').innerText = "Edit " + label; document.getElementById('editInput').value = SETTINGS[key] || ""; closeModal('adminMenuModal'); openModal('editModal'); }
async function submitEdit() {
  const newVal = document.getElementById('editInput').value;
  const payload = { password: adminSessionPw, [editingKey]: newVal };
  try {
    const res = await fetch("/api/update-links", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
    if((await res.json()).success) { location.reload(); } else { alert("Auth Failed"); }
  } catch(e) { alert("Error"); }
}
function copyLink(n) { const url = n === 1 ? SETTINGS.sub1 : SETTINGS.sub2; navigator.clipboard.writeText(url || "").then(() => alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")); }
</script>
</body>
</html>
